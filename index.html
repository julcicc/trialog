<!doctype html>
<html>
  <head>
    <title>Trialog</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="trialog.css">

    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.5/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script>html5.addElements('todo')</script>
    <![endif]-->

  </head>

  <body>

    <trialog></trialog>

    <script src="trialog.tag" type="riot/tag"></script>
    <script src="//rawgit.com/riot/riot/master/riot%2Bcompiler.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>

    <script>

    function TrainingSession(type, distance, duration, txt, plannedDistance, plannedDuration) {
        this.type = type;

        if (!plannedDistance) plannedDistance = 0;
        if (!plannedDuration) plannedDuration = 0;
        if (!distance) distance = 0;
        if (!duration) duration = 0;

        this.distance = distance;
        this.duration = duration;
        this.plannedDistance = plannedDistance;
        this.plannedDuration = plannedDuration;
        this.txt = txt;
    }

    function TrainingDay(moment) {
        this.moment = moment;
        this.sessions = [
            new TrainingSession("swim",1500,60*25,"1500N")
            , new TrainingSession("bike",60*1000,60*120,"2H")
            , new TrainingSession("run",10*1000,60*50,"50' CCL")
            , new TrainingSession("other",0,60*30,"4x8 Fuerza")
            ];
    }

    function TrainingSummary() {
        this.totalTime = 0;
        this.totalDistance = 0;
        this.plannedTime = 0;
        this.plannedDistance = 0;
    }

    var main = riot.observable();
    main._currentMoment = moment();
    main._days = null;

    main.getWeeklyTotals = function() {
        var days = main.getDays();
        var result = { "global" : new TrainingSummary()
                    , "swim" : new TrainingSummary()
                    , "bike" : new TrainingSummary()
                    , "run" : new TrainingSummary() }
        for (var i = 0; i < days.length; i++ ) {
            for ( var j = 0; j < days[i].sessions.length; j++ ) {
                var session = days[i].sessions[j];
                result.global.totalTime += session.duration;
                result.global.totalDistance += session.distance;
                result.global.plannedTime += session.plannedDuration;
                result.global.plannedDistance += session.plannedDistance;
                if (session.type=="swim" || session.type=="bike" || session.type=="run" ) {
                    result[ session.type ].totalTime += session.duration;
                    result[ session.type ].totalDistance += session.distance;
                    result[ session.type ].plannedTime += session.plannedDuration;
                    result[ session.type ].plannedDistance += session.plannedDistance;
                }
            }
        }
        return result;
    }

    main.getMoment = function() {
        return main._currentMoment.clone();
    }

    main.setMoment = function( newMoment ) {
        main._currentMoment = newMoment;
        main._days = null; //XXX
        main.trigger('momentChanged');
    }

    main.getDays = function() { 
        if (main._days == null) {
            var startMoment = main._currentMoment.day(1);
            var result = [ new TrainingDay(startMoment) ]
            for (var i = 1; i < 7; i++ ) {
                result.push( new TrainingDay(startMoment.clone().add(i,'days')) );
            }
            main._days = result;
        }
        return main._days;
    };

    riot.mount('trialog', main );

    </script>

  </body>

</html>
